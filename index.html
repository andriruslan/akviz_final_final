<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>АкВіз_КАГАРЛИК</title>
  <style>
  html, body {
  max-width: 100%;
  overflow-x: hidden;
}
.two-rows-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.two-rows-buttons .half-width {
  flex: 1 1 calc(50% - 0.5rem);
}
    /* --- Стилі як на akustychno-visualno.vercel.app --- */
    body {
      margin: 0;
      padding: 20px;
      background-color: #121212;
      font-family: 'Consolas', 'Courier New', monospace;
      color: #e0e0e0;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }
    .container {
      max-width: 480px;
      width: 95vw;
    }
    h2 {
      text-align: center;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: #eee;
      font-family: 'Consolas', monospace;
    }
    .group {
      margin-bottom: 1.2rem;
    }
    label {
      display: block;
      margin-bottom: 0.3rem;
      color: #bbb;
      font-weight: 600;
      font-size: 1rem;
    }
    input[type="text"],
    input[type="number"],
    input[type="time"],
    textarea,
    select {
      width: 100%;
      padding: 8px 10px;
      font-size: 1rem;
      background-color: #1e1e1e;
      border: 1px solid #333;
      border-radius: 4px;
      color: #e0e0e0;
      box-sizing: border-box;
      transition: border-color 0.3s;
      font-family: 'Consolas', monospace;
    }
    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #40a9ff;
      background-color: #252525;
    }
    button {
      background-color: #282828;
      color: #e0e0e0;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 8px 12px;
      font-family: 'Consolas', monospace;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
      margin-right: 8px;
    }
    button:hover {
      background-color: #3a3a3a;
    }
    .radio-group label {
      display: block;
      cursor: pointer;
      font-weight: normal;
      color: #ccc;
      margin-bottom: 0.2rem;
    }
    .radio-group input[type="radio"],
    .radio-group input[type="checkbox"] {
      margin-right: 8px;
      cursor: pointer;
    }
    .inline-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }
    #preview {
      background-color: #1a1a1a;
      border: 1px solid #333;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
      color: #ddd;
      min-height: 100px;
      user-select: text;
    }
    .plus-button {
      background-color: #2e7d32;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 12px;
      flex: 1 1 calc(50% - 0.5rem);
    }
    .minus-button {
      background-color: #c62828;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 12px;
      flex: 1 1 calc(50% - 0.5rem);
    }
    .plus-button:hover,
    .minus-button:hover {
      opacity: 0.85;
    }
    .result-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .result-group label {
      flex: 1 1 calc(33.333% - 1rem);
    }
    .checkbox-inline-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .checkbox-inline-group label {
      flex: 1 1 calc(50% - 1rem);
    }
    .ammo-flex {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .ammo-flex .ammo-item {
      flex: 1 1 calc(50% - 1rem);
    }
    hr {
      border: none;
      border-bottom: 1px solid #444;
      margin: 6px 0 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>АкВіз_КАГАРЛИК</h2>

    <div class="group">
      <label>Підпорядкування</label>
      <hr>
      <input type="text" id="sector">
    </div>

    <div class="group">
      <label>Позиція</label>
      <hr>
      <input type="text" id="position">
    </div>

    <div class="group">
      <label>Населений пункт</label>
      <hr>
      <input type="text" id="location">
    </div>

    <div class="group">
      <label>Тип цілі</label>
      <hr>
      <div class="radio-group">
        <label><input type="radio" name="target" value="БПЛА літакового типу"> 111БПЛА літакового типу</label>
        <label><input type="radio" name="target" value="Постріли (ЗУ, кулемет)"> Постріли (ЗУ, кулемет)</label>
        <label><input type="radio" name="target" value="Виходи (ПЗРК, ЗРК)"> Виходи (ПЗРК, ЗРК)</label>
        <label><input type="radio" name="target" value="Вибух КР"> Вибух КР</label>
        <label><input type="radio" name="target" value="Гелікоптер"> Гелікоптер</label>
        <label><input type="radio" name="target" value="Літак (малий)"> Літак (малий)</label>
        <label><input type="radio" name="target" value="Літак (великий)"> Літак (великий)</label>
        <label><input type="radio" name="target" value="Зонд"> Зонд</label>
        <label><input type="radio" name="target" value="Невстановлене"> Невстановлене</label>
        <label><input type="radio" name="target" value="Інше"> Інше</label>
        <label><input type="radio" name="target" value="Аеростат"> Аеростат</label>
      </div>
    </div>
    <div class="group">
      <label>Сторона</label>
      <hr>
      <div class="radio-group">
        <label><input type="radio" name="side" value="Ворожий"> Ворожий</label>
        <label><input type="radio" name="side" value="Свій"> Свій</label>
        <label><input type="radio" name="side" value="Нейтральний"> Нейтральний</label>
      </div>
    </div>

    <div class="group">
      <label>Номер цілі</label>
      <hr>
      <input id="targetNumber" type="number" inputmode="numeric" pattern="[0-9]*" min="0" step="1" />
    </div>

    <div class="group">
      <label>Назва</label>
      <hr>
      <input type="text" id="targetName">
      <div class="inline-buttons">
        <button class="minus-button" onclick="setTargetNameAndUpdate('Shahed-136')">Shahed-136</button>
        <button class="minus-button" onclick="setTargetNameAndUpdate('Гербера')">Гербера</button>
      </div>
    </div>

    <div class="group">
      <label>Кількість, од</label>
      <hr>
      <div class="inline-buttons">
        <button class="plus-button" onclick="changeCount(1)">+1 од.</button>
        <button class="minus-button" onclick="changeCount(-1)" id="minusBtn">-1 од.</button>
        <input type="number" id="targetCount" value="1" readonly>
      </div>
    </div>

    <div class="group">
      <label>Азимут, °</label>
      <hr>
      <input type="number" id="azimuth" placeholder="Введіть або визначте" inputmode="numeric" pattern="[0-9]*" min="0" max="359" step="1">
      <button id="azimuthBtn" onclick="toggleSensor('azimuth')">визначити азимут</button>
    </div>

    <div class="group">
      <label>Курс, °</label>
      <hr>
      <input type="number" id="course" placeholder="Введіть або визначте" inputmode="numeric" pattern="[0-9]*" min="0" max="359" step="1">
      <button id="courseBtn" onclick="toggleSensor('course')">визначити Курс</button>
    </div>

    <div class="group">
      <label>Відстань+, м</label>
      <hr>
      <input type="number" id="distance" placeholder="висота прольоту цілі" inputmode="numeric" pattern="[0-9]*">
      <div class="inline-buttons">
        <button class="plus-button" onclick="adjustValue('distance', 100)">+100 м</button>
        <button class="plus-button" onclick="adjustValue('distance', 1000)">+1000 м</button>
        <button class="plus-button" onclick="adjustValue('distance', 5000)">+5000 м</button>
        <button class="minus-button" onclick="adjustValue('distance', -100)">-100 м</button>
        <button class="minus-button" onclick="adjustValue('distance', -1000)">-1000 м</button>
        <button class="minus-button" onclick="adjustValue('distance', -5000)">-5000 м</button>
      </div>
    </div>

    <div class="group">
      <label>Висота, м</label>
      <hr>
      <input type="number" id="height" placeholder="висота цілі" inputmode="numeric" pattern="[0-9]*">
      <div class="two-rows-buttons">
        <button class="plus-button half-width" onclick="adjustValue('height', 100)">+100 м</button>
        <button class="plus-button half-width" onclick="adjustValue('height', 500)">+500 м</button>
        <button class="minus-button half-width" onclick="adjustValue('height', -100)">-100 м</button>
        <button class="minus-button half-width" onclick="adjustValue('height', -500)">-500 м</button>
      </div>
    </div>

<!-- 15. Час -->
    <div class="group">
      <label>Час</label>
      <hr>
      <input type="time" id="time">
      <div class="inline-buttons">
        <button class="plus-button" onclick="setNowTime()">Щойно</button>
        <button class="plus-button" onclick="changeTime(1)">+1 хв</button>
        <button class="minus-button" onclick="changeTime(-1)">-1 хв</button>
      </div>
    </div>

    <div class="group">
      <label>Виявлення</label>
      <hr>
      <div class="checkbox-inline-group">
        <label><input type="checkbox" id="acoustic"> Акустично</label>
        <label><input type="checkbox" id="radar"> Радіолокаційно</label>
        <label><input type="checkbox" id="visual" onchange="checkDetect()"> Візуально</label>
        <label><input type="checkbox" id="obs" disabled> Прилади</label>
      </div>
    </div>

    <div class="group">
      <label>Результат</label>
      <hr>
      <div class="result-group">
        <label><input type="radio" name="result" value="Виявлено" onchange="updateAmmoVisibility()"> Виявлено</label>
        <label><input type="radio" name="result" value="Обстріляно" onchange="updateAmmoVisibility()"> Обстріляно</label>
        <label><input type="radio" name="result" value="Уражено" onchange="updateAmmoVisibility()"> Уражено</label>
      </div>
    </div>

    <div class="group" id="ammoGroup" style="display:none;">
      <label>Розхід БК</label>
      <hr>
      <div class="ammo-flex">
        <div class="ammo-item">
          <label><input type="checkbox" id="ammo1" onchange="toggleAmmoCount('ammo1')"> АК-74 - 5.45</label>
          <input type="number" id="ammo1Count" disabled inputmode="numeric" pattern="[0-9]*">
        </div>
        <div class="ammo-item">
          <label><input type="checkbox" id="ammo2" onchange="toggleAmmoCount('ammo2')"> CANiK M2</label>
          <input type="number" id="ammo2Count" disabled inputmode="numeric" pattern="[0-9]*">
        </div>
        <div class="ammo-item">
          <label><input type="checkbox" id="ammo3" onchange="toggleAmmoCount('ammo3')"> ДП-27 7.62</label>
          <input type="number" id="ammo3Count" disabled inputmode="numeric" pattern="[0-9]*">
        </div>
        <!--
        <div class="ammo-item">
          <label><input type="checkbox" id="ammo4" onchange="toggleAmmoCount('ammo4')"> Інше</label>
          <input type="number" id="ammo4Count" disabled inputmode="numeric" pattern="[0-9]*">
        </div>
        -->
      </div>
    </div>

    <div class="group">
      <label>Опис</label>
      <hr>
      <div class="checkbox-inline-group">
        <label><input type="checkbox" id="descSound"> змінений звук</label>
        <label><input type="checkbox" id="descCourse"> змінений курс</label>
      </div>
      <textarea id="description" rows="3" maxlength="360" placeholder="Додатковий опис (до 360 символів)"></textarea>
    </div>

    <div class="group">
      <label>Міні-звіт</label>
      <hr>
      <pre id="preview"></pre>
    </div>

    <div class="group inline-buttons">
      <button class="plus-button" onclick="copyReport()">Копіювати звіт</button>
      <button class="plus-button" onclick="sendToSignal()">Надіслати в Signal</button>
    </div>

    <div class="group">
      <label>🧪 Діагностика компаса</label>
      <div id="debug">Очікування даних...</div>
    </div>

  </div> <!-- /container -->



<script>
// --- Збереження полів до localStorage ---
function toggleLock(id) {
  const input = document.getElementById(id);
  input.readOnly = !input.readOnly;
  if (input.readOnly) {
    localStorage.setItem(id, input.value);
  } else {
    input.focus();
  }
}

function loadStored() {
  ['sector','position','location'].forEach(id => {
    const val = localStorage.getItem(id);
    if (val) document.getElementById(id).value = val;
  });
  toggleNumberField();
}

// --- Кількість цілей ---
function changeCount(delta) {
  const field = document.getElementById('targetCount');
  let val = parseInt(field.value) + delta;
  if (val <= 1) {
    val = 1;
    document.getElementById('minusBtn').disabled = true;
  } else {
    document.getElementById('minusBtn').disabled = false;
  }
  field.value = val;
  updatePreview();
}

// --- Номер цілі: вимкнення поля при "Без видачі" ---
function toggleNumberField() {
  const noNum = document.getElementById('noNumber').checked;
  const numInput = document.getElementById('targetNumber');
  numInput.readOnly = noNum;
  if (noNum) numInput.value = '';
  updatePreview();
}

// --- Додавання/віднімання значення
function adjustValue(id, delta) {
  const field = document.getElementById(id);
  let val = parseInt(field.value) || 0;
  val += delta;
  if (val < 0) val = 0;
  field.value = val;
  updatePreview();
}

// --- Час
function setNowTime() {
  const now = new Date();
  const h = now.getHours().toString().padStart(2, '0');
  const m = now.getMinutes().toString().padStart(2, '0');
  document.getElementById('time').value = `${h}:${m}`;
  updatePreview();
}

function changeTime(delta) {
  const timeInput = document.getElementById('time');
  let [h,m] = timeInput.value.split(':').map(Number);
  if (isNaN(h) || isNaN(m)) return setNowTime();
  let date = new Date();
  date.setHours(h, m + delta);
  const nh = date.getHours().toString().padStart(2,'0');
  const nm = date.getMinutes().toString().padStart(2,'0');
  timeInput.value = `${nh}:${nm}`;
  updatePreview();
}

// --- Виявлення
function checkDetect() {
  const visual = document.getElementById('visual').checked;
  const obs = document.getElementById('obs');
  obs.disabled = !visual;
  if (!visual) obs.checked = false;
  updatePreview();
}

// --- Розхід БК: відображення
function updateAmmoVisibility() {
  const results = document.getElementsByName('result');
  let show = false;
  results.forEach(r => {
    if ((r.checked) && (r.value === 'Обстріляно' || r.value === 'Уражено')) show = true;
  });
  const ammoGroup = document.getElementById('ammoGroup');
  if (ammoGroup) ammoGroup.style.display = show ? 'block' : 'none';
}

// --- Активувати/деактивувати поля боєприпасів
function toggleAmmoCount(id) {
  const cb = document.getElementById(id);
  const countInput = document.getElementById(id + 'Count');
  countInput.disabled = !cb.checked;
  if (!cb.checked) countInput.value = '';
  updatePreview();
}

// --- Формування тексту звіту ---
function generateReportText() {
  const sector = document.getElementById('sector').value;
  const position = document.getElementById('position').value;
  const location = document.getElementById('location').value;

  let targetType = '';
  document.querySelectorAll('input[name="target"]').forEach(r => { if(r.checked) targetType = r.value; });

  let side = '';
  document.querySelectorAll('input[name="side"]').forEach(r => { if(r.checked) side = r.value; });

  const noNumber = document.getElementById('noNumber').checked;
  const targetNumber = noNumber ? "без видачі" : (document.getElementById('targetNumber').value || '');

  const targetName = document.getElementById('targetName').value;
  const targetCount = document.getElementById('targetCount').value;

  const azimuth = document.getElementById('azimuth').value;
  const course = document.getElementById('course').value;
  const distance = document.getElementById('distance').value;
  const height = document.getElementById('height').value;
  const time = document.getElementById('time').value;

  const acoustic = document.getElementById('acoustic').checked ? "Акустично" : "";
  const radar = document.getElementById('radar').checked ? "Радар" : "";
  const visual = document.getElementById('visual').checked ? "Візуально" : "";
  const obs = document.getElementById('obs').checked ? "Засоби спостереження" : "";

  let resultValue = "";
  document.getElementsByName('result').forEach(r => { if(r.checked) resultValue = r.value; });

  let ammoText = '';
  if (resultValue === 'Обстріляно' || resultValue === 'Уражено') {
    const ammoMap = {
      'ammo1': 'АК-74 - 5.45',
      'ammo2': 'CANiK M2',
      'ammo3': 'ДП-27 7.62',
      // 'ammo4': 'Інше' // закоментовано згідно з вимогами
    };
    for (const key in ammoMap) {
      if (document.getElementById(key)?.checked) {
        const count = document.getElementById(key + 'Count').value || 0;
        ammoText += `${ammoMap[key]}: ${count} шт.\n`;
      }
    }
  }

  const descSound = document.getElementById('descSound').checked ? "змінений звук" : "";
  const descCourse = document.getElementById('descCourse').checked ? "змінений курс" : "";
  const description = document.getElementById('description').value;
  let descriptionFull = [descSound, descCourse, description].filter(Boolean).join('; ');

  let report = `П: ${sector}, ${position}\n`;
  report += `Ціль: ${targetType}, ${side}, ${noNumber ? "без видачі" : targetNumber}\n`;
  if (targetName) report += `Назва: ${targetName}\n`;
  report += `Висота: ${height} м\n`;
  report += `Відстань: ${distance} м\n`;
  report += `Кількість: ${targetCount} од\n`;
  report += `А: ${azimuth}°\n`;
  report += `К: ${course}°\n`;
  report += `НП: ${location}\n`;
  report += `Час: ${time}\n`;
  report += `Вияв: ${[acoustic, radar, visual, obs].filter(Boolean).join(', ')}\n`;
  report += `ПП: ${resultValue}\n`;
  if (ammoText) report += `Розхід Б:\n${ammoText}`;
  if (descriptionFull) report += `Опис: ${descriptionFull}\n`;

  return report;
}

// --- Копіювання звіту ---
function copyReport() {
  const text = generateReportText();
  navigator.clipboard.writeText(text).then(() => {
    document.getElementById("preview").textContent = text;
  });
}

// --- Відправка в Signal ---
function sendToSignal() {
  const text = generateReportText();
  navigator.clipboard.writeText(text).then(() => {
    document.getElementById("preview").textContent = text;
    window.location.href = "sgnl://";
  });
}

// --- Визначення азимуту / курсу ---
let sensorActive = { azimuth: false, course: false };
let currentField = null;

function toggleSensor(field) {
  if (sensorActive[field]) {
    sensorActive[field] = false;
    document.getElementById(field + 'Btn').textContent = field === 'azimuth' ? 'визначити азимут' : 'визначити Курс';
    currentField = null;
    window.removeEventListener('deviceorientation', onDeviceOrientation);
    document.getElementById('debug').textContent = 'Дані компаса зупинено.';
  } else {
    if (typeof DeviceOrientationEvent !== 'undefined' &&
        typeof DeviceOrientationEvent.requestPermission === 'function') {
      DeviceOrientationEvent.requestPermission().then(response => {
        if (response === 'granted') startSensor(field);
        else alert('Доступ до датчиків відмовлено.');
      }).catch(console.error);
    } else {
      startSensor(field);
    }
  }
}

function startSensor(field) {
  sensorActive[field] = true;
  currentField = field;
  document.getElementById(field + 'Btn').textContent = 'зберегти';
  window.addEventListener('deviceorientation', onDeviceOrientation);
  document.getElementById('debug').textContent = 'Визначення ' + (field === 'azimuth' ? 'азимуту' : 'курсу') + '...';
}

function onDeviceOrientation(event) {
  if (!currentField) return;
  let heading = event.webkitCompassHeading ?? (event.absolute !== false ? 360 - event.alpha : null);
  if (heading !== null) {
    heading = Math.round(heading);
    if (heading > 359) heading = 359;
    document.getElementById(currentField).value = heading;
    document.getElementById('debug').textContent = `Визначення ${currentField}: ${heading}°`;
    updatePreview();
  }
}

// --- Інші допоміжні ---
function setTargetNameAndUpdate(name) {
  const targetNameInput = document.getElementById('targetName');
  targetNameInput.value = name;
  updatePreview();
}

function updatePreview() {
  document.getElementById("preview").textContent = generateReportText();
}

function attachReportUpdateListeners() {
  const inputs = document.querySelectorAll("input, textarea, select");
  inputs.forEach(el => {
    el.addEventListener("input", updatePreview);
    if (el.type === "checkbox" || el.type === "radio") {
      el.addEventListener("change", updatePreview);
    }
  });
}

document.querySelectorAll("button").forEach(btn => {
  btn.addEventListener("dblclick", e => e.preventDefault());
});

window.onload = () => {
  loadStored();
  toggleNumberField();
  setNowTime();
  updateAmmoVisibility();
  checkDetect();
  attachReportUpdateListeners();
  updatePreview();
  document.querySelectorAll('input[name="result"]').forEach(el => {
    el.addEventListener("change", updateAmmoVisibility);
  });
};
</script>
</body>
</html>
